<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Market Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" rel="stylesheet" />
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-main: #e2e8f0;
      --text-sub: #94a3b8;
      --accent: #3b82f6;
      --up-color: #ef4444;
      --down-color: #3b82f6;
      --border: #334155;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Pretendard", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 10px;
      padding-bottom: 60px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header,
    .market-section,
    .news-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    header {
      padding: 20px;
      margin-bottom: 20px;
    }

    .date-badge {
      background: var(--accent);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 700;
      display: inline-block;
      margin-bottom: 10px;
    }

    .progress-wrap {
      margin-top: 15px;
    }

    .progress-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }

    .progress-bar-container {
      background: #0b1220;
      border-radius: 10px;
      overflow: hidden;
      height: 8px;
      width: 100%;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #60a5fa);
      width: 0%;
      transition: width 0.8s ease-in-out;
    }

    .market-section {
      padding: 20px;
      margin-bottom: 20px;
    }

    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 860px;
    }

    th,
    td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      text-align: right;
    }

    th {
      text-align: left;
      color: var(--text-sub);
      font-size: 0.75rem;
      text-transform: uppercase;
      white-space: nowrap;
    }

    td:first-child,
    th:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: var(--card-bg);
      z-index: 10;
      font-weight: 700;
      color: white;
      min-width: 130px;
      border-right: 1px solid var(--border);
    }

    .text-up { color: var(--up-color); }
    .text-down { color: var(--down-color); }

    .sparkline-cell {
      width: 150px;
      height: 50px;
      padding: 4px !important;
    }

    .sparkline-container {
      width: 100%;
      height: 100%;
    }

    .insight-box {
      background: rgba(59, 130, 246, 0.1);
      padding: 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .news-card {
      padding: 20px;
    }

    .news-header {
      font-weight: 700;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--accent);
      gap: 8px;
    }

    .refresh-btn {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-sub);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.72rem;
      cursor: pointer;
    }

    .refresh-btn:hover {
      color: #fff;
      border-color: var(--accent);
    }

    .news-item {
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding-bottom: 8px;
    }

    .news-item:last-child { border-bottom: none; }

    .news-source {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: block;
    }

    .news-title {
      color: var(--text-main);
      text-decoration: none;
      font-size: 0.9rem;
      display: block;
      line-height: 1.4;
    }

    .news-title:hover { text-decoration: underline; }

    .muted { color: var(--text-sub); }

    footer {
      margin-top: 30px;
      padding: 20px;
      text-align: center;
      border-top: 1px solid var(--border);
      color: var(--text-sub);
      font-size: 0.8rem;
    }

    .thai-proverb {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div id="date-display" class="date-badge">Loading...</div>
      <div id="greeting-block">
        안녕하세요.<br />
        태국의 계절 기운 속에서 흔들림 없는 원칙으로 하루를 시작하시길 바랍니다.<br />
        시장의 소음 속에서도 논리적인 판단이 빛을 발하는 날이 될 것입니다.
      </div>

      <div class="progress-wrap" style="margin-top: 25px;">
        <div class="progress-row">
          <span id="year-label">올해 진행률</span>
          <span id="year-percent-txt" style="color:var(--accent); font-weight:700;">0%</span>
        </div>
        <div class="progress-bar-container">
          <div id="year-bar" class="progress-bar-fill"></div>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-row">
          <span id="contract-label">계약 경과율 (Since 2025.08.22)</span>
          <span id="contract-percent-txt" style="color:var(--accent); font-weight:700;">0%</span>
        </div>
        <div class="progress-bar-container">
          <div id="contract-bar" class="progress-bar-fill"></div>
        </div>
      </div>
    </header>

    <section class="market-section">
      <h3 style="margin-top:0;">Market Watch (5Y Trend)</h3>
      <div class="insight-box">
        <strong>[Market Insight]</strong><br />
        <span id="expert-comment">데이터 로딩 중...</span>
      </div>

      <div class="table-scroll">
        <table id="market-table">
          <thead>
            <tr>
              <th>Index</th>
              <th>Price</th>
              <th style="width:150px;">Trend (5Y)</th>
              <th>DoD</th>
              <th>MoM</th>
              <th>YoY</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="news-grid">
      <div class="news-card">
        <div class="news-header">🇰🇷 한국 경제 <button class="refresh-btn" data-news="news-korea-econ">24H 새로고침</button></div>
        <div id="news-korea-econ">Loading...</div>
      </div>
      <div class="news-card">
        <div class="news-header">🇹🇭 태국 경제 <button class="refresh-btn" data-news="news-thai-econ">24H 새로고침</button></div>
        <div id="news-thai-econ">Loading...</div>
      </div>
      <div class="news-card">
        <div class="news-header">🌏 국제 경제 <button class="refresh-btn" data-news="news-global-econ">24H 새로고침</button></div>
        <div id="news-global-econ">Loading...</div>
      </div>
      <div class="news-card">
        <div class="news-header">🇰🇷 한국 뉴스 <button class="refresh-btn" data-news="news-korea-soc">24H 새로고침</button></div>
        <div id="news-korea-soc">Loading...</div>
      </div>
      <div class="news-card">
        <div class="news-header">🇹🇭 태국 뉴스 <button class="refresh-btn" data-news="news-thai-soc">24H 새로고침</button></div>
        <div id="news-thai-soc">Loading...</div>
      </div>
      <div class="news-card">
        <div class="news-header">🌏 국제 뉴스 <button class="refresh-btn" data-news="news-global-soc">24H 새로고침</button></div>
        <div id="news-global-soc">Loading...</div>
      </div>
    </div>

    <footer>
      <div class="thai-proverb">
        <div style="color: var(--accent); font-size: 1.1rem; margin-bottom:5px;">ความพยายามอยู่ที่ไหน ความสำเร็จอยู่ที่นั่น</div>
        <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:5px;">[콰-암 파야얌 유- 티- 나이, 콰-암 쌈렛 유- 티- 난]</div>
        <strong>"노력이 있는 곳에 성공이 있다."</strong>
        <p style="margin-top:8px; font-size:0.9rem; color:#cbd5e1;">
          꾸준함이 최고의 재능입니다. 당신이 흘린 땀방울은 배신하지 않습니다.
        </p>
      </div>
      <br />
      <div style="font-size: 0.7rem; opacity: 0.7;">
        Charts provided by <a href="https://www.tradingview.com/" style="color: var(--text-sub);">TradingView Lightweight Charts™</a>
      </div>
    </footer>
  </div>

  <script>
  const CONFIG = {
    MARKET_TIMEZONE: "Asia/Bangkok",
    CONTRACT_START: "2025-08-22",
    CONTRACT_TOTAL_DAYS: 678
  };

  const MARKET_SYMBOLS = [
    { key: "NASDAQ", label: "NASDAQ" },
    { key: "S&P500", label: "S&P 500" },
    { key: "KOSPI", label: "KOSPI" },
    { key: "KOSPI100", label: "KOSPI 100" },
    { key: "KOSDAQ", label: "KOSDAQ" },
    { key: "SET Index", label: "SET Index" },
    { key: "SET50", label: "SET50" },
    { key: "BTC/USD", label: "BTC/USD" },
    { key: "BTC/KRW", label: "BTC/KRW" },
    { key: "DXY", label: "Dollar Index" },
    { key: "USD/JPY", label: "USD/JPY" },
    { key: "USD/KRW", label: "USD/KRW" },
    { key: "USD/THB", label: "USD/THB" },
    { key: "THB/KRW", label: "THB/KRW" }
  ];

  const NEWS_SECTIONS = [
    { id: "news-korea-econ" },
    { id: "news-thai-econ" },
    { id: "news-global-econ" },
    { id: "news-korea-soc" },
    { id: "news-thai-soc" },
    { id: "news-global-soc" }
  ];

  function getThaiNow() {
    const now = new Date();
    const text = new Intl.DateTimeFormat("sv-SE", {
      timeZone: CONFIG.MARKET_TIMEZONE,
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      hour12: false
    }).format(now);
    return new Date(text.replace(" ", "T"));
  }

  function isoWeek(d) {
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  }

  function dayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 1);
    return Math.floor((date - start) / 86400000) + 1;
  }

  function round2(v) {
    return Math.round(v * 100) / 100;
  }

  function daysBetweenInclusive(startDate, endDate) {
    const s = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const e = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    if (e < s) return 0;
    return Math.floor((e - s) / 86400000) + 1;
  }

  function setProgressBar(id, value) {
    const clamped = Math.max(0, Math.min(100, value));
    document.getElementById(id).style.width = `${clamped.toFixed(2)}%`;
  }

  function initDateAndProgress() {
    const now = getThaiNow();
    const thaiYear = now.getFullYear() + 543;
    const month = now.getMonth() + 1;
    const date = now.getDate();
    const week = isoWeek(now);
    const koDays = ["일", "월", "화", "수", "목", "금", "토"];
    const thDays = ["วันอาทิตย์", "วันจันทร์", "วันอังคาร", "วันพุธ", "วันพฤหัสบดี", "วันศุกร์", "วันเสาร์"];
    const dayIdx = now.getDay();

    document.getElementById("date-display").innerText = `불기 ${thaiYear}년 ${month}월 ${date}일 (${week}/52주, ${koDays[dayIdx]}요일 / ${thDays[dayIdx]})`;

    const doy = dayOfYear(now);
    const yearPercent = round2((doy / 365) * 100);
    document.getElementById("year-label").innerText = `올해 진행률 (${doy}/365)`;
    document.getElementById("year-percent-txt").innerText = `${yearPercent.toFixed(2)}%`;
    setProgressBar("year-bar", yearPercent);

    const contractStart = new Date(`${CONFIG.CONTRACT_START}T00:00:00`);
    const elapsed = daysBetweenInclusive(contractStart, now);
    const contractPercent = round2((elapsed / CONFIG.CONTRACT_TOTAL_DAYS) * 100);
    document.getElementById("contract-label").innerText = `계약 경과율 (${elapsed}/${CONFIG.CONTRACT_TOTAL_DAYS})`;
    document.getElementById("contract-percent-txt").innerText = `${contractPercent.toFixed(2)}%`;
    setProgressBar("contract-bar", contractPercent);
  }

  function fmtNum(v, digits = 2) {
    if (v == null || Number.isNaN(v)) return "데이터없음";
    return Number(v).toLocaleString("ko-KR", { minimumFractionDigits: digits, maximumFractionDigits: digits });
  }

  function fmtPriceByKey(key, v) {
    if (v == null || Number.isNaN(v)) return "데이터없음";
    if (key === "BTC/USD") return `${fmtNum(v, 2)}`;
    if (key === "BTC/KRW") return `₩${fmtNum(v, 0)}`;
    if (key === "USD/KRW" || key === "THB/KRW") return fmtNum(v, 2);
    return fmtNum(v, 2);
  }

  function clsByPct(v) {
    if (v == null || Number.isNaN(v)) return "";
    return v >= 0 ? "text-up" : "text-down";
  }

  function fmtPct(v) {
    if (v == null || Number.isNaN(v)) return "데이터없음";
    const sign = v >= 0 ? "+" : "";
    return `${sign}${fmtNum(v)}%`;
  }

  function createSparkline(containerId, points, color) {
    const container = document.getElementById(containerId);
    if (!container || points.length < 2 || typeof LightweightCharts === "undefined") return;
    const chart = LightweightCharts.createChart(container, {
      layout: { background: { type: "solid", color: "transparent" }, textColor: "transparent", attributionLogo: false },
      grid: { vertLines: { visible: false }, horzLines: { visible: false } },
      width: container.clientWidth,
      height: container.clientHeight,
      rightPriceScale: { visible: false },
      timeScale: { visible: false },
      crosshair: { visible: false },
      handleScroll: false,
      handleScale: false
    });
    const lineSeries = chart.addLineSeries({
      color,
      lineWidth: 2,
      crosshairMarkerVisible: false,
      lastValueVisible: false,
      priceLineVisible: false
    });
    lineSeries.setData(points.map(p => ({ time: p.time, value: p.value })));
    chart.timeScale().fitContent();

    new ResizeObserver(entries => {
      if (!entries.length || entries[0].target !== container) return;
      chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
    }).observe(container);
  }

  async function loadJson(path) {
    const url = `${path}?t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`${path} ${res.status}`);
    return res.json();
  }

  async function renderMarket() {
    const tbody = document.querySelector("#market-table tbody");
    const insight = document.getElementById("expert-comment");
    tbody.innerHTML = "";

    try {
      const data = await loadJson("./data/market.json");
      const byKey = new Map((data.items || []).map(v => [v.key, v]));

      MARKET_SYMBOLS.forEach((item, idx) => {
        const d = byKey.get(item.key) || { label: item.label, points: [], price: null, dod: null, mom: null, yoy: null };
        const chartId = `spark-${idx}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.label || item.label}</td>
          <td style="font-weight:600;">${fmtPriceByKey(item.key, d.price)}</td>
          <td class="sparkline-cell"><div id="${chartId}" class="sparkline-container"></div></td>
          <td class="${clsByPct(d.dod)}">${fmtPct(d.dod)}</td>
          <td class="${clsByPct(d.mom)}">${fmtPct(d.mom)}</td>
          <td class="${clsByPct(d.yoy)}">${fmtPct(d.yoy)}</td>
        `;
        tbody.appendChild(tr);

        if (Array.isArray(d.points) && d.points.length > 10) {
          const color = (d.dod ?? 0) >= 0 ? "#ef4444" : "#3b82f6";
          createSparkline(chartId, d.points, color);
        }
      });

      const generatedAt = data.generated_at ? new Date(data.generated_at).toLocaleString("ko-KR") : "알 수 없음";
      insight.textContent = `${data.insight || "시장 데이터 코멘트 없음"} (업데이트: ${generatedAt})`;
    } catch (e) {
      insight.textContent = `시장 데이터 파일 로딩 실패: ${e.message}`;
    }
  }

  function renderNewsItems(containerId, items) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (!items.length) {
      container.innerHTML = `<div class="muted" style="font-size:0.85rem;">데이터없음</div>`;
      return;
    }

    container.innerHTML = "";
    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "news-item";
      const dateText = item.publishedAt ? new Date(item.publishedAt).toLocaleString("ko-KR") : "시간없음";
      const sourceText = item.source?.name || "출처미상";
      const numHint = item.numericHint || "데이터없음";
      const url = item.url || "#";
      const title = item.title || "제목없음";
      div.innerHTML = `
        <span class="news-source">${sourceText} · ${dateText} · 수치:${numHint}</span>
        <a href="${url}" target="_blank" rel="noopener noreferrer" class="news-title">${title}</a>
      `;
      container.appendChild(div);
    });
  }

  async function loadAllNews() {
    try {
      const data = await loadJson("./data/news.json");
      for (const sec of NEWS_SECTIONS) {
        renderNewsItems(sec.id, data.sections?.[sec.id] || []);
      }
    } catch (e) {
      for (const sec of NEWS_SECTIONS) {
        renderNewsItems(sec.id, []);
      }
    }
  }

  function bindNewsRefresh() {
    document.querySelectorAll(".refresh-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        await loadAllNews();
      });
    });
  }

  async function init() {
    initDateAndProgress();
    bindNewsRefresh();
    await renderMarket();
    await loadAllNews();
  }

  init();
</script>
</body>
</html>

